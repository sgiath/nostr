#!/usr/bin/env bash

set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
RELAY_APP_DIR="$ROOT_DIR/nostr-relay"
CLIENT_APP_DIR="$ROOT_DIR/nostr-client"

RELAY_HOST="${NOSTR_E2E_RELAY_HOST:-127.0.0.1}"
RELAY_PORT="${NOSTR_E2E_RELAY_PORT:-4002}"
RELAY_ENABLED="${NOSTR_RELAY_ENABLED:-true}"
RELAY_URL="${NOSTR_E2E_RELAY_URL:-ws://$RELAY_HOST:$RELAY_PORT/}"

if ! [[ "$RELAY_PORT" =~ ^[0-9]+$ ]]; then
  echo "Invalid relay port: $RELAY_PORT"
  exit 1
fi

cleanup() {
  if [[ -n "${RELAY_PID:-}" ]] && kill -0 "$RELAY_PID" 2>/dev/null; then
    kill "$RELAY_PID" 2>/dev/null || true
    wait "$RELAY_PID" 2>/dev/null || true
  fi
}
trap cleanup EXIT INT TERM

(
  cd "$RELAY_APP_DIR"
  MIX_ENV=dev \
    NOSTR_RELAY_ENABLED="$RELAY_ENABLED" \
    NOSTR_RELAY_PORT="$RELAY_PORT" \
    mix run --no-halt
) &
RELAY_PID=$!

timeout=8
while [ "$timeout" -gt 0 ]; do
  if (exec 3<>/dev/tcp/$RELAY_HOST/$RELAY_PORT) 2>/dev/null; then
    exec 3>&-
    break
  fi
  timeout=$((timeout - 1))
  sleep 1
done

if [ "$timeout" -le 0 ]; then
  echo "Relay did not become available at ws://$RELAY_HOST:$RELAY_PORT/"
  exit 1
fi

(
  cd "$CLIENT_APP_DIR"
  NOSTR_E2E_RELAY_URL="$RELAY_URL" \
    mix test --only external "$@"
)
